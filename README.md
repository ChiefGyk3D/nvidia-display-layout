# NVIDIA X11 Persistent Multi-Monitor Layout

A deterministic, NVIDIA-native display layout solution for X11 that avoids xrandr, GNOME display settings, and hotplug race conditions.

## Features

- ‚úÖ **Interactive setup wizard** - configure any monitor setup
- ‚úÖ Persistent layout across reboot
- ‚úÖ Portrait/landscape monitor support (no squish)
- ‚úÖ Optional HDMI capture card mirroring
- ‚úÖ No display reordering
- ‚úÖ Manual toggle + auto-apply on login
- ‚úÖ Uses only NVIDIA MetaModes

## Requirements

- NVIDIA proprietary driver
- X11 (not Wayland)
- `nvidia-settings`
- Bash 4.0+

## Quick Start (Recommended)

Run the interactive setup wizard:

```bash
./setup-wizard.sh
```

The wizard will:
1. Detect your connected displays
2. Let you configure position, resolution, and rotation for each
3. Optionally set up HDMI capture card mirroring
4. Generate personalized scripts
5. Enable the systemd service
6. Apply the layout immediately

## Directory Structure

After running the wizard, files are installed to:

```
$HOME/
‚îú‚îÄ‚îÄ .screenlayout/
‚îÇ   ‚îú‚îÄ‚îÄ apply-layout.sh      # Smart selector script
‚îÇ   ‚îú‚îÄ‚îÄ nvidia-base.sh       # Base layout (auto-generated)
‚îÇ   ‚îú‚îÄ‚îÄ nvidia-capture.sh    # Layout with HDMI capture (if configured)
‚îÇ   ‚îî‚îÄ‚îÄ .layout-config       # Saved configuration
‚îÇ
‚îî‚îÄ‚îÄ .config/systemd/user/
    ‚îî‚îÄ‚îÄ apply-display-layout.service
```

## Manual Installation

If you prefer to configure manually or customize the example scripts:

### 1. Copy the screenlayout scripts

```bash
mkdir -p ~/.screenlayout
cp .screenlayout/* ~/.screenlayout/
chmod +x ~/.screenlayout/*.sh
```

### 2. Copy the systemd service

```bash
mkdir -p ~/.config/systemd/user
cp .config/systemd/user/apply-display-layout.service ~/.config/systemd/user/
```

### 3. Enable the service

```bash
systemctl --user daemon-reload
systemctl --user enable apply-display-layout.service
```

### 4. Set up a keyboard shortcut

Bind this command in your desktop settings (e.g., **Pop!_OS ‚Üí Keyboard ‚Üí Custom Shortcuts**):

```
/home/YOUR_USERNAME/.screenlayout/apply-layout.sh
```

**Recommended keys:**
- `Super + F12`
- `Ctrl + Alt + D`

## Scripts

### üü¢ nvidia-base.sh

Applies your base display layout (without capture card). Generated by the wizard or manually configured.

### üîµ nvidia-capture.sh

Applies the layout with HDMI capture card enabled (mirrors your chosen display). Only created if you configure a capture card.

### üü£ apply-layout.sh

Smart selector that detects whether the capture device is connected and applies the correct MetaMode automatically.

### üßô setup-wizard.sh

Interactive configuration wizard. Run this to:
- Detect all connected displays
- Configure position (left/center/right)
- Set resolution per display
- Configure rotation (normal/left/right/inverted)
- Set up HDMI capture card mirroring
- Generate all scripts automatically

## Usage

1. Plug/unplug HDMI capture card
2. Press your hotkey to apply the correct layout

The layout is also automatically applied on login via the systemd service.

## Verification

Check the current MetaMode:

```bash
nvidia-settings -q CurrentMetaMode
```

‚úî Must **NOT** say `source=RandR`

Check display connections:

```bash
nvidia-settings -q dpys
```

‚úî HDMI shows `connected` when plugged  
‚úî DPY mappings remain stable

## Core Design Philosophy

| Principle | Description |
|-----------|-------------|
| **No xrandr** | NVIDIA MetaModes only |
| **No GNOME Displays** | Avoids config conflicts |
| **No udev hotplug** | No race conditions |
| **No timers** | Deterministic execution |
| **Only NVIDIA MetaModes** | Native driver control |
| **Deterministic** | Same result every time |
| **Manual toggle + auto-apply** | User-controlled with login automation |

## What is Intentionally NOT Included

| Excluded | Reason |
|----------|--------|
| ‚ùå xrandr | Conflicts with NVIDIA MetaModes |
| ‚ùå GNOME Displays | Creates inconsistent state |
| ‚ùå NVIDIA "Save X Config" | Overwrites with RandR settings |
| ‚ùå udev rules | Race conditions with display init |
| ‚ùå systemd timers | Unnecessary polling |
| ‚ùå Auto-hotplug hacks | Unreliable detection |
| ‚ùå ViewPortIn / ViewPortOut | Not needed for this layout |
| ‚ùå Panning | Causes display artifacts |

## Customization

### Using the Wizard (Recommended)

Simply run `./setup-wizard.sh` again to reconfigure. Your previous settings are saved in `~/.screenlayout/.layout-config`.

### Manual Configuration

To manually edit the MetaMode strings:

1. Run `nvidia-settings -q dpys` to identify your display names (DPY-0, DPY-1, etc.)
2. Update the MetaMode strings in `nvidia-base.sh` and `nvidia-capture.sh`
3. Adjust position offsets (`+X+Y`) to match your physical layout
4. Update the detection string in `apply-layout.sh` if needed

### MetaMode Syntax

```
DPY-X: WIDTHxHEIGHT +X_OFFSET+Y_OFFSET {Rotation=Left|Right|Inverted}
```

Example for a 3-monitor setup with right display in portrait:

```bash
nvidia-settings --assign "CurrentMetaMode=\
DPY-3: 1920x1080 +0+0, \
DPY-5: 1920x1080 +1920+0, \
DPY-1: 1920x1080 +3840+0 {Rotation=Right}"
```

## Troubleshooting

### Layout resets after sleep/wake

Re-run the apply script:

```bash
~/.screenlayout/apply-layout.sh
```

### MetaMode shows source=RandR

Something is overwriting NVIDIA settings. Check for:
- GNOME display configuration
- Other display management tools
- Conflicting autostart scripts

### Wrong display detected as HDMI

Update the grep pattern in `apply-layout.sh` to match your capture card's identifier.

### Reconfiguring after hardware changes

Run the wizard again:

```bash
./setup-wizard.sh
```

## Example Configurations

### Dual Monitor (Side by Side)

```
[Left: 1920x1080] [Right: 1920x1080]
```

### Triple Monitor with Portrait

```
[Left: 1920x1080] [Center: 2560x1440] [Right: 1080x1920 Portrait]
```

### Ultrawide + Secondary

```
[Ultrawide: 3440x1440] [Side: 1920x1080]
```

### With Capture Card

```
[Left] [Center + Capture Mirror] [Right Portrait]
```

## License

MIT
